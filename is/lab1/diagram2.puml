@startuml

title Архитектура приложения Vehicle Management (с импортом и AOP)

skinparam packageStyle rectangle
skinparam linetype ortho

package "Уровень представления" {
    class Frontend {
        +VehicleList
        +VehicleCreate
        +VehicleEdit
        +VehicleDetails
        +SpecialOperations
        +Import
    }
    
    class WSClient {
        +WebSocket connection
        +onMessage()
        +onOpen()
        +onClose()
    }
}

package "Уровень REST API" {
    class VehicleController {
        +createVehicle()
        +getVehicleById()
        +getAllVehicles()
        +updateVehicle()
        +deleteVehicle()
        +getVehicleWithMaxCapacity()
        +getVehiclesByNamePrefix()
        +getVehiclesByFuelConsumption()
        +getVehiclesByType()
        +resetDistanceTravelled()
    }
    
    class CoordinatesController {
        +getAllCoordinates()
        +getCoordinatesById()
    }
    
    class ImportController {
        +importVehicles()
        +getImportHistory()
    }
    
    class JaxRsApplication {
        +configure()
    }
}

package "AOP (Aspect-Oriented Programming)" {
    annotation ImportLock {
        +value(): String
    }
    
    annotation Logged {
    }
    
    class ImportLockInterceptor {
        -locks: ConcurrentHashMap
        +intercept()
        -getLock()
    }
    
    class LoggingInterceptor {
        +logMethod()
    }
}

package "Уровень бизнес-логики" {
    interface VehicleService {
        +createVehicle()
        +getVehicleById()
        +getAllVehicles()
        +updateVehicle()
        +deleteVehicle()
        +getVehicleWithMaxCapacity()
        +getVehiclesByNamePrefix()
        +getVehiclesByFuelConsumption()
        +getVehiclesByType()
        +resetDistanceTravelled()
        +getVehiclesWithFilters()
    }
    
    class VehicleServiceImpl {
        +createVehicle()
        +getVehicleById()
        +getAllVehicles()
        +updateVehicle()
        +deleteVehicle()
        +getVehicleWithMaxCapacity()
        +getVehiclesByNamePrefix()
        +getVehiclesByFuelConsumption()
        +getVehiclesByType()
        +resetDistanceTravelled()
        +getVehiclesWithFilters()
        -getOrCreateCoordinates()
        -convertToDTO()
        -validateCreateDTO()
        -validateUpdateDTO()
    }
    
    interface CoordinatesService {
        +getAllCoordinates()
        +getCoordinatesById()
    }
    
    class CoordinatesServiceImpl {
        +getAllCoordinates()
        +getCoordinatesById()
        -convertToDTO()
    }
    
    interface ImportService {
        +importVehicles()
        +getImportHistory()
    }
    
    class ImportServiceImpl {
        +importVehicles()
        +getImportHistory()
        -validateImportDTO()
        -checkUniquenessInSession()
        -getOrCreateCoordinates()
    }
    
    interface UniquenessService {
        +checkNameTypeUniqueness()
        +checkTechnicalConfigUniqueness()
    }
    
    class UniquenessServiceImpl {
        +checkNameTypeUniqueness()
        +checkTechnicalConfigUniqueness()
    }
}

package "DTO слой" {
    class VehicleDTO {
        -Integer id
        -String name
        -Long coordinatesId
        -double x
        -long y
        -Long creationDate
        -VehicleType type
        -int enginePower
        -int numberOfWheels
        -double capacity
        -long distanceTravelled
        -long fuelConsumption
        -FuelType fuelType
    }
    
    class VehicleCreateDTO {
        -String name
        -Long coordinatesId
        -Double x
        -Long y
        -VehicleType type
        -int enginePower
        -int numberOfWheels
        -double capacity
        -long distanceTravelled
        -long fuelConsumption
        -FuelType fuelType
    }
    
    class VehicleUpdateDTO {
        -String name
        -Double x
        -Long y
        -VehicleType type
        -Integer enginePower
        -Integer numberOfWheels
        -Double capacity
        -Long distanceTravelled
        -Long fuelConsumption
        -FuelType fuelType
    }
    
    class VehicleImportDTO {
        -String name
        -Double x
        -Long y
        -VehicleType type
        -Integer enginePower
        -Integer numberOfWheels
        -Double capacity
        -Long distanceTravelled
        -Long fuelConsumption
        -FuelType fuelType
    }
    
    class ImportOperationDTO {
        -Long id
        -String status
        -String username
        -Integer addedCount
        -String errorMessage
        -Long createdAt
    }
    
    class ImportResultDTO {
        -Long operationId
        -String status
        -Integer addedCount
        -String errorMessage
    }
    
    class CoordinatesDTO {
        -Long id
        -double x
        -long y
    }
    
    class PaginatedResponse {
        -List<T> content
        -long totalElements
        -int totalPages
        -int currentPage
        -int pageSize
    }
    
    class ErrorResponse {
        -int status
        -String error
        -String message
        -String path
    }
}

package "Уровень доступа к данным" {
    interface VehicleDAO {
        +save()
        +findById()
        +findByIdWithLock()
        +findAll()
        +count()
        +update()
        +deleteById()
        +findByMaxCapacity()
        +findByNameStartsWith()
        +findByFuelConsumptionGreaterThan()
        +findByType()
        +resetDistanceTravelled()
        +findWithFilters()
        +countWithFilters()
        +findByNameAndType()
        +findByEnginePowerCapacityAndFuelType()
    }
    
    class VehicleDAOImpl {
        +save()
        +findById()
        +findByIdWithLock()
        +findAll()
        +count()
        +update()
        +deleteById()
        +findByMaxCapacity()
        +findByNameStartsWith()
        +findByFuelConsumptionGreaterThan()
        +findByType()
        +resetDistanceTravelled()
        +findWithFilters()
        +countWithFilters()
        +findByNameAndType()
        +findByEnginePowerCapacityAndFuelType()
    }
    
    interface CoordinatesDAO {
        +save()
        +findById()
        +findByXAndY()
        +findAll()
        +count()
    }
    
    class CoordinatesDAOImpl {
        +save()
        +findById()
        +findByXAndY()
        +findAll()
        +count()
    }
    
    interface UserDAO {
        +save()
        +findById()
        +findByUsername()
        +findAll()
    }
    
    class UserDAOImpl {
        +save()
        +findById()
        +findByUsername()
        +findAll()
    }
    
    interface ImportOperationDAO {
        +save()
        +findById()
        +findAll()
        +findByUserId()
        +update()
    }
    
    class ImportOperationDAOImpl {
        +save()
        +findById()
        +findAll()
        +findByUserId()
        +update()
    }
}

package "Уровень Entity" {
    class Vehicle {
        -Integer id
        -String name
        -Coordinates coordinates
        -Date creationDate
        -VehicleType type
        -int enginePower
        -int numberOfWheels
        -double capacity
        -long distanceTravelled
        -long fuelConsumption
        -FuelType fuelType
    }
    
    class Coordinates {
        -Long id
        -double x
        -long y
    }
    
    class User {
        -Long id
        -String username
        -boolean admin
    }
    
    class ImportOperation {
        -Long id
        -ImportStatus status
        -User user
        -Integer addedCount
        -String errorMessage
        -Date createdAt
    }
    
    enum VehicleType {
        CAR
        HELICOPTER
        BOAT
        HOVERBOARD
    }
    
    enum FuelType {
        KEROSENE
        ELECTRICITY
        DIESEL
        ALCOHOL
    }
    
    enum ImportStatus {
        IN_PROGRESS
        SUCCESS
        FAILED
    }
}

package "Конфигурация" {
    class HibernateUtil {
        -SessionFactory sessionFactory
        +getSessionFactory()
        +shutdown()
    }
    
    class CorsFilter {
        +filter()
    }
}

package "WebSocket" {
    class VehicleWebSocket {
        +onOpen()
        +onClose()
        +onError()
        +onMessage()
        +broadcast()
        +notifyVehicleDeleted()
        +notifyVehicleCreated()
        +notifyVehicleUpdated()
        +notifyImportCompleted()
    }
}

package "База данных" {
    class DB_Vehicle {
        id (PK)
        name
        coordinates_id (FK)
        creation_date
        type
        engine_power
        number_of_wheels
        capacity
        distance_travelled
        fuel_consumption
        fuel_type
    }
    
    class DB_Coordinates {
        id (PK)
        x
        y
    }
    
    class DB_AppUsers {
        id (PK)
        username (UNIQUE)
        is_admin
    }
    
    class DB_ImportOperations {
        id (PK)
        status
        user_id (FK)
        added_count
        error_message
        created_at
    }
}

' Связи Frontend → Backend
Frontend --> VehicleController : HTTP REST
Frontend --> CoordinatesController : HTTP REST
Frontend --> ImportController : HTTP REST
WSClient --> VehicleWebSocket : WebSocket

' Связи Controller → Service
VehicleController --> VehicleService : @Inject
VehicleController --> VehicleDTO : uses
VehicleController --> VehicleCreateDTO : uses
VehicleController --> VehicleUpdateDTO : uses
VehicleController --> PaginatedResponse : uses
VehicleController --> ErrorResponse : uses

CoordinatesController --> CoordinatesService : @Inject
CoordinatesController --> CoordinatesDTO : uses
CoordinatesController --> ErrorResponse : uses

ImportController --> ImportService : @Inject
ImportController --> VehicleImportDTO : uses
ImportController --> ImportResultDTO : uses
ImportController --> ImportOperationDTO : uses

' Связи Service → DAO
VehicleService <|.. VehicleServiceImpl : implements
VehicleServiceImpl --> VehicleDAO : @Inject
VehicleServiceImpl --> CoordinatesDAO : @Inject
VehicleServiceImpl --> UniquenessService : @Inject
VehicleServiceImpl --> VehicleWebSocket : notify
VehicleServiceImpl --> VehicleDTO : converts to

CoordinatesService <|.. CoordinatesServiceImpl : implements
CoordinatesServiceImpl --> CoordinatesDAO : @Inject
CoordinatesServiceImpl --> CoordinatesDTO : converts to

ImportService <|.. ImportServiceImpl : implements
ImportServiceImpl --> VehicleDAO : @Inject
ImportServiceImpl --> CoordinatesDAO : @Inject
ImportServiceImpl --> UserDAO : @Inject
ImportServiceImpl --> ImportOperationDAO : @Inject
ImportServiceImpl --> HibernateUtil : @Inject
ImportServiceImpl --> VehicleWebSocket : notify
ImportServiceImpl --> ImportResultDTO : returns

UniquenessService <|.. UniquenessServiceImpl : implements
UniquenessServiceImpl --> VehicleDAO : @Inject

' AOP связи
ImportLockInterceptor --> ImportLock : intercepts
LoggingInterceptor --> Logged : intercepts
ImportServiceImpl --> ImportLock : @ImportLock
ImportServiceImpl --> Logged : @Logged

' Связи DAO → Entity
VehicleDAO <|.. VehicleDAOImpl : implements
VehicleDAOImpl --> HibernateUtil : @Inject
VehicleDAOImpl --> Vehicle : uses

CoordinatesDAO <|.. CoordinatesDAOImpl : implements
CoordinatesDAOImpl --> HibernateUtil : @Inject
CoordinatesDAOImpl --> Coordinates : uses

UserDAO <|.. UserDAOImpl : implements
UserDAOImpl --> HibernateUtil : @Inject
UserDAOImpl --> User : uses

ImportOperationDAO <|.. ImportOperationDAOImpl : implements
ImportOperationDAOImpl --> HibernateUtil : @Inject
ImportOperationDAOImpl --> ImportOperation : uses

' Связи Entity
Vehicle --> Coordinates : has
Vehicle --> VehicleType : uses
Vehicle --> FuelType : uses
ImportOperation --> User : belongs to
ImportOperation --> ImportStatus : uses

' Связи Hibernate → Database
HibernateUtil --> Vehicle : maps
HibernateUtil --> Coordinates : maps
HibernateUtil --> User : maps
HibernateUtil --> ImportOperation : maps
Vehicle --> DB_Vehicle : persists to
Coordinates --> DB_Coordinates : persists to
User --> DB_AppUsers : persists to
ImportOperation --> DB_ImportOperations : persists to

' Связь между таблицами БД
DB_Vehicle --> DB_Coordinates : FK coordinates_id
DB_ImportOperations --> DB_AppUsers : FK user_id

' JAX-RS Application
JaxRsApplication --> VehicleController : registers
JaxRsApplication --> CoordinatesController : registers
JaxRsApplication --> ImportController : registers
JaxRsApplication --> CorsFilter : registers

note right of VehicleServiceImpl
@Stateless
@Inject VehicleDAO
@Inject CoordinatesDAO
@Inject UniquenessService

Программные ограничения:
- Name + Type уникальны
- EnginePower + Capacity + FuelType уникальны

Пессимистическая блокировка:
- findByIdWithLock() для update/delete
end note

note right of ImportServiceImpl
@Stateless
@Inject VehicleDAO, CoordinatesDAO
@Inject UserDAO, ImportOperationDAO
@Inject HibernateUtil

@ImportLock - пессимистическая блокировка
@Logged - AOP логирование

Транзакция SERIALIZABLE:
- Атомарный импорт
- Rollback при любой ошибке
end note

note right of UniquenessServiceImpl
@Stateless
@Inject VehicleDAO

Программные ограничения уникальности:
1. Name + Type
2. EnginePower + Capacity + FuelType

Проверяется при создании/обновлении
end note

note right of ImportLockInterceptor
@Interceptor
@Priority(Interceptor.Priority.APPLICATION)

Пессимистическая блокировка:
- ReentrantLock для каждого ключа
- ConcurrentHashMap для хранения
- Последовательное выполнение импортов
end note

note right of VehicleDAOImpl
@Stateless
@Inject HibernateUtil

Новые методы:
- findByIdWithLock() - PESSIMISTIC_WRITE
- findByNameAndType() - проверка уникальности
- findByEnginePowerCapacityAndFuelType()

Изоляция: SERIALIZABLE
end note

note right of Vehicle
@Entity
@Table(name = "vehicle")

Программные ограничения:
- name + type уникальны
- enginePower + capacity + fuelType уникальны

Mapped using XML:
Vehicle.hbm.xml
end note

note right of ImportOperation
@Entity
@Table(name = "import_operations")

Связь с User (many-to-one)
Статус: IN_PROGRESS, SUCCESS, FAILED

Mapped using XML:
ImportOperation.hbm.xml
end note

note right of VehicleWebSocket
@ServerEndpoint("/ws/vehicles")

Broadcasts real-time updates:
- CREATED
- UPDATED
- DELETED
- IMPORT_COMPLETED
end note

note right of HibernateUtil
@ApplicationScoped
SessionFactory management

Mapped entities:
- Vehicle.hbm.xml
- Coordinates.hbm.xml
- AppUser.hbm.xml
- ImportOperation.hbm.xml
end note

note right of Frontend
React компоненты:
- VehicleList (таблица с пагинацией)
- VehicleCreate (форма создания)
- VehicleEdit (форма редактирования)
- VehicleDetails (просмотр)
- SpecialOperations (доп. операции)
- Import (импорт + история + роли)

WebSocket для real-time обновлений
Переключение user/admin
end note

@enduml

